
<Window
    x:Class="FlowerPlayer.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:FlowerPlayer"
    xmlns:converters="using:FlowerPlayer.Converters"
    xmlns:controls="using:FlowerPlayer.Controls"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    Title="FlowerPlayer Ver 0.0.2.2 (撥放、歷史清單、波形圖、修正刪除實體檔案的錯誤)">

    <Window.SystemBackdrop>
        <MicaBackdrop />
    </Window.SystemBackdrop>

    <Grid x:Name="RootGrid" AllowDrop="True" DragOver="Grid_DragOver" Drop="Grid_Drop"
          IsTabStop="True" UseSystemFocusVisuals="False" Loaded="MainWindow_Loaded"
            DataContext="{x:Bind ViewModel}">
        <Grid.Resources>
            <converters:BoolToVisConverter x:Key="BoolToVisConverter" />
            <converters:PlayPauseLabelConverter x:Key="PlayPauseLabelConverter" />
            <converters:TimeConverter x:Key="TimeConverter" />
        </Grid.Resources>
        <Grid.RowDefinitions>
            <RowDefinition Height="*" /> <!-- Video -->
            <RowDefinition Height="Auto" /> <!-- Waveform -->
            <RowDefinition Height="Auto" /> <!-- Timeline -->
            <RowDefinition Height="Auto" /> <!-- Controls -->
            <RowDefinition Height="Auto" /> <!-- Status Bar -->
        </Grid.RowDefinitions>

        <!-- Video Area -->
        <MediaPlayerElement x:Name="PlayerElement" 
                            Grid.Row="0" 
                            HorizontalAlignment="Stretch" 
                            VerticalAlignment="Stretch"
                            AreTransportControlsEnabled="False"
                            PointerPressed="MediaArea_PointerPressed"/>

        <!-- Waveform Area -->
        <Grid Grid.Row="1" Height="60" Visibility="{Binding IsWaveformVisible, Mode=OneWay, Converter={StaticResource BoolToVisConverter}}"
              Margin="10,0"
              Background="Transparent"
              PointerPressed="MediaArea_PointerPressed">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="100"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="100"/>
            </Grid.ColumnDefinitions>
            <controls:WaveformControl x:Name="WaveformControl" Grid.Column="1" Margin="10,0"
                                     WaveformData="{x:Bind ViewModel.WaveformData, Mode=OneWay}" 
                                     IsHitTestVisible="False"/>
        </Grid>

        <!-- Timeline Control -->
        <Grid Grid.Row="2" Margin="10,5">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="100"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="100"/>
            </Grid.ColumnDefinitions>
            <TextBlock Text="{x:Bind FormatTime(ViewModel.CurrentTime), Mode=OneWay}" VerticalAlignment="Center" TextAlignment="Right" FontFamily="Consolas, Courier New, Monospace"/>
            
            <!-- Custom Range Slider -->
            <controls:RangeSlider x:Name="TimelineSlider" Grid.Column="1" Margin="10,0"
                               Minimum="0"
                               Maximum="{x:Bind ViewModel.TotalDuration.TotalSeconds, Mode=OneWay}"
                               Value="{x:Bind ViewModel.SliderPosition, Mode=TwoWay}"
                               RangeStart="{x:Bind ViewModel.RangeStart, Mode=TwoWay}"
                               RangeEnd="{x:Bind ViewModel.RangeEnd, Mode=TwoWay}"/>
            
            <TextBlock Grid.Column="2" Text="{x:Bind FormatTime(ViewModel.TotalDuration), Mode=OneWay}" VerticalAlignment="Center" TextAlignment="Left" FontFamily="Consolas, Courier New, Monospace"/>
        </Grid>

        <!-- Controls -->
        <StackPanel Grid.Row="3" Orientation="Vertical" HorizontalAlignment="Center" Margin="0,5,0,5" Spacing="10">
            <!-- Main Controls -->
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Spacing="10">
                <Button Content="＜分" Command="{x:Bind ViewModel.SeekBackwardCommand}" IsEnabled="{x:Bind ViewModel.IsFileLoaded, Mode=OneWay}"/>
                <Button Content="＜幀" Command="{x:Bind ViewModel.StepPrevFrameCommand}" IsEnabled="{x:Bind ViewModel.HasVideo, Mode=OneWay}"/>
                <Button Content="停止" Command="{x:Bind ViewModel.StopCommand}" IsEnabled="{x:Bind ViewModel.IsFileLoaded, Mode=OneWay}"/>
                <Button x:Name="PlayPauseButton"
                        Content="{Binding IsPlaying, Mode=OneWay, Converter={StaticResource PlayPauseLabelConverter}}"
                        Command="{x:Bind ViewModel.PlayPauseCommand}" Style="{StaticResource AccentButtonStyle}"
                        IsEnabled="{x:Bind ViewModel.IsFileLoaded, Mode=OneWay}"/>
                <Button Content="幀＞" Command="{x:Bind ViewModel.StepNextFrameCommand}" IsEnabled="{x:Bind ViewModel.HasVideo, Mode=OneWay}"/>
                <Button Content="分＞" Command="{x:Bind ViewModel.SeekForwardCommand}" IsEnabled="{x:Bind ViewModel.IsFileLoaded, Mode=OneWay}"/>
                <Button Content="上個檔" Click="PlayPreviousFile_Click" IsEnabled="{x:Bind ViewModel.IsFileLoaded, Mode=OneWay}"/>
                <Button Content="下個檔" Click="PlayNextFile_Click" IsEnabled="{x:Bind ViewModel.IsFileLoaded, Mode=OneWay}"/>
                <Button Content="開啟檔案" Click="OpenFile_Click"/>
                
                <!-- MenuBar for Playlist -->
                <MenuBar VerticalAlignment="Center">
                    <MenuBarItem Title="選單">
                        <MenuFlyoutItem Text="設定" Click="OpenSettings_Click"/>
                        <MenuFlyoutItem Text="播放清單" Click="OpenPlaylist_Click"/>
                        <MenuFlyoutItem Text="歷史清單" Click="OpenHistory_Click"/>
                    </MenuBarItem>
                </MenuBar>
                
                <CheckBox Content="循環撥放" IsChecked="{x:Bind ViewModel.IsLooping, Mode=TwoWay}" IsEnabled="{x:Bind ViewModel.IsFileLoaded, Mode=OneWay}"/>
                <Button Content="設定起點" Command="{x:Bind ViewModel.SetRangeStartCommand}" IsEnabled="{x:Bind ViewModel.IsFileLoaded, Mode=OneWay}"/>
                <Button Content="設定終點" Command="{x:Bind ViewModel.SetRangeEndCommand}" IsEnabled="{x:Bind ViewModel.IsFileLoaded, Mode=OneWay}"/>
                <ToggleButton Content="快速跳播" IsChecked="{x:Bind ViewModel.IsSmartSkipActive, Mode=TwoWay}" IsEnabled="{x:Bind ViewModel.IsFileLoaded, Mode=OneWay}"/>
                <ToggleButton Content="顯示波形" IsChecked="{x:Bind ViewModel.IsWaveformVisible, Mode=TwoWay}" IsEnabled="{x:Bind ViewModel.IsFileLoadedAndNotGeneratingWaveform, Mode=OneWay}"/>
                <Button Command="{x:Bind ViewModel.ToggleMuteCommand}" Background="Transparent" BorderThickness="0">
                    <FontIcon Glyph="{x:Bind ViewModel.VolumeIcon, Mode=OneWay}"/>
                </Button>
                <Slider Width="150" Minimum="0" Maximum="1" StepFrequency="0.01" 
                        Value="{x:Bind ViewModel.Volume, Mode=TwoWay}" VerticalAlignment="Center"/>
            </StackPanel>
        </StackPanel>
        
        <!-- Status Bar -->
        <Border Grid.Row="4" Background="{ThemeResource SystemControlBackgroundChromeMediumLowBrush}" Padding="10,2">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <TextBlock Grid.Column="0" Text="{x:Bind ViewModel.StatusMessage, Mode=OneWay}" FontSize="16" VerticalAlignment="Center"/>
                <TextBlock Grid.Column="1" Text="{x:Bind ViewModel.CurrentFileName, Mode=OneWay}" FontSize="16" VerticalAlignment="Center" TextAlignment="Center" TextTrimming="CharacterEllipsis"/>
                <TextBlock Grid.Column="2" Text="{x:Bind ViewModel.CurrentFileDirectory, Mode=OneWay}" FontSize="16" VerticalAlignment="Center" TextAlignment="Right" TextTrimming="CharacterEllipsis"/>
            </Grid>
        </Border>
    </Grid>
</Window>
